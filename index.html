<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#6B5CE7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.svg">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
    <title>Sudoku Kids - Fun Puzzle Game!</title>
    <script>
        if (window.location.protocol !== 'file:') {
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = 'manifest.json';
            document.head.appendChild(link);

            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    // Use relative path for GitHub Pages compatibility
                    const swPath = window.location.pathname.replace(/\/[^\/]*$/, '/sw.js');
                    navigator.serviceWorker.register(swPath).catch(() => {});
                });
            }
        }
    </script>
    <style>
        :root {
            --primary: #6B5CE7;
            --primary-light: #8B7CF7;
            --secondary: #FF6B9D;
            --accent: #FFD93D;
            --success: #6BCB77;
            --bg-main: #F0E6FF;
            --bg-card: #FFFFFF;
            --text: #4A4A6A;
            --text-light: #8888AA;
            --shadow: rgba(107, 92, 231, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-main);
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
        }

        /* Import playful font */
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');

        /* Fun background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(107, 92, 231, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(255, 107, 157, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 50% 50%, rgba(255, 217, 61, 0.05) 0%, transparent 30%);
            pointer-events: none;
            z-index: -1;
        }

        .app-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 15px;
            padding-bottom: 100px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 15px 0;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            animation: bounce 2s ease infinite;
        }

        .logo-text {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* Player Stats */
        .player-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
        }

        .stat-bubble {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px var(--shadow);
            font-weight: 700;
        }

        .stat-icon {
            font-size: 1.3rem;
        }

        .stat-value {
            color: var(--primary);
            font-size: 1.1rem;
        }

        /* Theme Selector */
        .theme-selector {
            background: var(--bg-card);
            border-radius: 25px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 4px 20px var(--shadow);
        }

        .theme-title {
            text-align: center;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .theme-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            padding: 5px;
        }

        /* On mobile, use horizontal scroll */
        @media (max-width: 500px) {
            .theme-grid {
                flex-wrap: nowrap;
                justify-content: flex-start;
                overflow-x: auto;
                scrollbar-width: none;
            }

            .theme-grid::-webkit-scrollbar {
                display: none;
            }
        }

        .theme-option {
            flex-shrink: 0;
            width: 70px;
            height: 70px;
            border-radius: 18px;
            background: linear-gradient(135deg, #f0f0f0, #e0e0e0);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        @media (hover: hover) {
            .theme-option:hover {
                transform: scale(1.05);
            }
        }

        .theme-option.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(107, 92, 231, 0.3);
        }

        .theme-option .theme-icon {
            font-size: 1.8rem;
        }

        .theme-option .theme-name {
            font-size: 0.65rem;
            font-weight: 700;
            margin-top: 2px;
            color: var(--text);
        }

        /* Size Selector */
        .size-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }

        .size-btn {
            background: var(--bg-card);
            border: 3px solid transparent;
            border-radius: 15px;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 700;
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px var(--shadow);
        }

        @media (hover: hover) {
            .size-btn:hover {
                transform: translateY(-2px);
            }
        }

        .size-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border-color: var(--primary);
        }

        .size-btn .size-label {
            font-size: 0.7rem;
            opacity: 0.8;
            display: block;
            margin-top: 2px;
        }

        /* Game Board */
        .board-container {
            background: var(--bg-card);
            border-radius: 25px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 8px 30px var(--shadow);
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 5px;
        }

        .timer {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .moves-counter {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-light);
        }

        .board {
            display: grid;
            gap: 3px;
            margin: 0 auto;
            aspect-ratio: 1;
            padding: 10px;
            background: linear-gradient(135deg, #6B5CE7, #FF6B9D, #FFD93D, #6BCB77);
            background-size: 200% 200%;
            animation: gradientShift 8s ease infinite;
            border-radius: 22px;
            box-shadow: 0 8px 30px rgba(107, 92, 231, 0.3);
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .board.size-4 { 
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            padding: 12px;
        }
        .board.size-6 {
            grid-template-columns: repeat(2, 1fr);
            gap: 7px;
            padding: 10px;
        }
        .board.size-9 { 
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            padding: 8px;
        }

        /* Box containers */
        .box {
            display: grid;
            gap: 3px;
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            padding: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Alternating box colors for better visibility */
        .box:nth-child(odd) {
            background: rgba(255,255,255,0.98);
        }
        
        .box:nth-child(even) {
            background: rgba(240,230,255,0.95);
        }

        .board.size-4 .box {
            grid-template-columns: repeat(2, 1fr);
            border-radius: 15px;
            padding: 6px;
            gap: 4px;
        }

        .board.size-6 .box {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            padding: 5px;
        }

        .board.size-9 .box {
            grid-template-columns: repeat(3, 1fr);
            padding: 4px;
        }

        .cell {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #f8f8ff, #f0f0ff);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1.8rem;
            border: 2px solid rgba(107, 92, 231, 0.15);
            position: relative;
            overflow: hidden;
        }

        .board.size-4 .cell { 
            border-radius: 12px; 
            font-size: 2rem; 
        }
        
        .board.size-6 .cell { 
            border-radius: 8px; 
            font-size: 1.4rem; 
        }
        
        .board.size-9 .cell { 
            border-radius: 6px; 
            font-size: 1.1rem; 
        }

        /* Only apply hover on devices with hover capability */
        @media (hover: hover) {
            .cell:hover:not(.fixed) {
                transform: scale(1.08);
                box-shadow: 0 4px 15px var(--shadow);
                z-index: 2;
            }
        }

        .cell.selected {
            background: linear-gradient(135deg, rgba(107, 92, 231, 0.25), rgba(255, 107, 157, 0.25));
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(107, 92, 231, 0.4);
            z-index: 3;
        }

        .cell.fixed {
            background: linear-gradient(135deg, #ede9ff, #e0d8ff);
            border-color: rgba(107, 92, 231, 0.2);
        }

        .cell.error {
            animation: shake 0.4s ease;
            background: linear-gradient(135deg, rgba(255, 100, 100, 0.3), rgba(255, 150, 150, 0.2));
        }

        .cell.correct {
            animation: pop 0.3s ease;
        }

        .cell.hint {
            animation: glow 1s ease;
        }

        .cell.wrong {
            background: linear-gradient(135deg, rgba(255, 100, 100, 0.4), rgba(255, 150, 150, 0.3));
            border-color: #ff6b6b;
            animation: shake 0.4s ease;
        }

        .cell.right {
            background: linear-gradient(135deg, rgba(107, 203, 119, 0.3), rgba(74, 222, 128, 0.2));
            border-color: var(--success);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        @keyframes glow {
            0% { box-shadow: 0 0 0 0 rgba(255, 217, 61, 0.8); }
            50% { box-shadow: 0 0 20px 10px rgba(255, 217, 61, 0.4); }
            100% { box-shadow: 0 0 0 0 rgba(255, 217, 61, 0); }
        }

        /* Box borders - no longer needed with new layout */

        /* Palette */
        .palette {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
            padding: 10px;
            background: rgba(107, 92, 231, 0.05);
            border-radius: 20px;
        }

        .palette-item {
            width: 50px;
            height: 50px;
            border-radius: 15px;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1.6rem;
            border: 3px solid transparent;
            box-shadow: 0 3px 10px var(--shadow);
            position: relative;
        }

        .board.size-6 ~ .palette .palette-item { width: 45px; height: 45px; font-size: 1.4rem; }
        .board.size-9 ~ .palette .palette-item { width: 38px; height: 38px; font-size: 1.1rem; border-radius: 12px; }

        @media (hover: hover) {
            .palette-item:hover {
                transform: scale(1.1);
            }
        }

        .palette-item.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(107, 92, 231, 0.1), rgba(255, 107, 157, 0.1));
            transform: scale(1.1);
        }

        .palette-item .remaining {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: var(--primary);
            color: white;
            font-size: 0.6rem;
            font-weight: 700;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .palette-item .remaining.done {
            background: var(--success);
        }

        .palette-item.eraser {
            background: linear-gradient(135deg, #ffeeee, #ffdddd);
        }

        /* Action Buttons */
        .actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .action-btn {
            background: var(--bg-card);
            border: none;
            border-radius: 15px;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 700;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px var(--shadow);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        @media (hover: hover) {
            .action-btn:hover {
                transform: translateY(-2px);
            }
        }

        .action-btn.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
        }

        .action-btn.hint {
            background: linear-gradient(135deg, var(--accent), #ffcc00);
            color: var(--text);
        }

        .action-btn.check {
            background: linear-gradient(135deg, var(--success), #4ade80);
            color: white;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Mascot */
        .mascot {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 3rem;
            animation: float 3s ease-in-out infinite;
            cursor: pointer;
            z-index: 100;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2));
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }

        .mascot-bubble {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: var(--bg-card);
            border-radius: 20px;
            padding: 12px 18px;
            max-width: 200px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 5px 25px var(--shadow);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            z-index: 99;
        }

        .mascot-bubble.show {
            opacity: 1;
            transform: translateY(0);
        }

        .mascot-bubble::after {
            content: '';
            position: absolute;
            bottom: -10px;
            right: 30px;
            border: 10px solid transparent;
            border-top-color: var(--bg-card);
        }

        /* Win Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 30px;
            padding: 30px;
            text-align: center;
            max-width: 350px;
            width: 90%;
            transform: scale(0.8);
            transition: all 0.3s ease;
        }

        .modal-overlay.show .modal {
            transform: scale(1);
        }

        .modal-icon {
            font-size: 4rem;
            margin-bottom: 15px;
            animation: bounce 1s ease infinite;
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .modal-text {
            color: var(--text-light);
            margin-bottom: 20px;
        }

        .stars-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .star {
            font-size: 2.5rem;
            opacity: 0.3;
            transform: scale(0);
            animation: starPop 0.5s ease forwards;
        }

        .star.earned {
            opacity: 1;
        }

        .star:nth-child(1) { animation-delay: 0.2s; }
        .star:nth-child(2) { animation-delay: 0.4s; }
        .star:nth-child(3) { animation-delay: 0.6s; }

        @keyframes starPop {
            0% { transform: scale(0) rotate(-180deg); }
            50% { transform: scale(1.3) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .reward-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, var(--accent), #ffcc00);
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        /* Confetti */
        .confetti {
            position: fixed;
            width: 15px;
            height: 15px;
            background: var(--primary);
            border-radius: 3px;
            animation: confettiFall 3s ease-out forwards;
            z-index: 999;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Settings Modal */
        .settings-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            background: var(--bg-card);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 4px 15px var(--shadow);
            z-index: 100;
        }

        /* Difficulty indicator */
        .difficulty-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(107, 92, 231, 0.1);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--primary);
        }

        /* Loading state */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 50px;
        }

        .loading-spinner {
            font-size: 3rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Responsive - Small phones */
        @media (max-width: 400px) {
            .app-container {
                padding: 10px;
            }

            .logo-text {
                font-size: 1.6rem;
            }

            .logo-icon {
                width: 36px;
                height: 36px;
            }

            .player-bar {
                gap: 10px;
            }

            .stat-bubble {
                padding: 6px 12px;
            }

            .theme-option {
                width: 60px;
                height: 60px;
            }

            .theme-option .theme-icon {
                font-size: 1.5rem;
            }

            .size-btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }

            .cell {
                border-radius: 8px;
                font-size: 1.5rem;
            }

            .board.size-9 .cell {
                font-size: 0.9rem;
            }

            .palette-item {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
                border-radius: 12px;
            }

            .board.size-9 ~ .palette .palette-item {
                width: 32px;
                height: 32px;
                font-size: 0.9rem;
                border-radius: 10px;
            }

            .actions {
                flex-wrap: wrap;
            }

            .action-btn {
                padding: 10px 14px;
                font-size: 0.85rem;
            }

            .mascot {
                font-size: 2.5rem;
                bottom: 15px;
                right: 15px;
            }

            .mascot-bubble {
                bottom: 75px;
                right: 15px;
                max-width: 160px;
                font-size: 0.8rem;
                padding: 10px 14px;
            }

            .settings-btn {
                width: 40px;
                height: 40px;
                font-size: 1.1rem;
            }
        }

        /* Very small phones */
        @media (max-width: 350px) {
            .size-selector {
                gap: 5px;
            }

            .size-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            .actions {
                gap: 6px;
            }

            .action-btn {
                padding: 8px 10px;
                font-size: 0.8rem;
                gap: 4px;
            }
        }

        /* Desktop/Tablet landscape */
        @media (min-width: 768px) {
            .app-container {
                padding: 20px;
            }

            .board-container {
                padding: 20px;
            }

            .board {
                max-width: 450px;
            }
        }

        /* Tutorial overlay */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .tutorial-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .tutorial-card {
            background: var(--bg-card);
            border-radius: 30px;
            padding: 30px;
            text-align: center;
            max-width: 350px;
            width: 90%;
        }

        .tutorial-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .tutorial-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .tutorial-text {
            color: var(--text-light);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .tutorial-demo {
            background: rgba(107, 92, 231, 0.1);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .tutorial-mini-grid {
            display: inline-grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
        }

        .tutorial-mini-cell {
            width: 45px;
            height: 45px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border: 2px solid rgba(107, 92, 231, 0.2);
        }

        .tutorial-mini-cell.highlight {
            border-color: var(--primary);
            animation: pulse 1.5s ease infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(107, 92, 231, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(107, 92, 231, 0); }
        }

        .tutorial-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .tutorial-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(107, 92, 231, 0.2);
        }

        .tutorial-dot.active {
            background: var(--primary);
            width: 25px;
            border-radius: 5px;
        }

        .tutorial-btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border: none;
            border-radius: 15px;
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <img src="favicon.svg" alt="Sudoku Kids" class="logo-icon">
                <span class="logo-text">Sudoku Kids</span>
            </div>
        </header>

        <!-- Player Stats -->
        <div class="player-bar">
            <div class="stat-bubble">
                <span class="stat-icon">‚≠ê</span>
                <span class="stat-value" id="totalStars">0</span>
            </div>
            <div class="stat-bubble">
                <span class="stat-icon">üèÜ</span>
                <span class="stat-value" id="gamesWon">0</span>
            </div>
            <div class="stat-bubble">
                <span class="stat-icon">üî•</span>
                <span class="stat-value" id="streak">0</span>
            </div>
        </div>

        <!-- Theme Selector -->
        <div class="theme-selector">
            <div class="theme-title">Choose Your Friends!</div>
            <div class="theme-grid" id="themeGrid"></div>
        </div>

        <!-- Size Selector -->
        <div class="size-selector">
            <button class="size-btn active" data-size="4" onclick="selectSize(4)">
                4√ó4
                <span class="size-label">Easy</span>
            </button>
            <button class="size-btn" data-size="6" onclick="selectSize(6)">
                6√ó6
                <span class="size-label">Medium</span>
            </button>
            <button class="size-btn" data-size="9" onclick="selectSize(9)">
                9√ó9
                <span class="size-label">Hard</span>
            </button>
        </div>

        <!-- Game Board -->
        <div class="board-container">
            <div class="game-info">
                <div class="timer">
                    <span>‚è±Ô∏è</span>
                    <span id="timer">0:00</span>
                </div>
                <div class="difficulty-badge" id="difficultyBadge">
                    üåü Easy
                </div>
                <div class="moves-counter">
                    <span>‚úèÔ∏è</span>
                    <span id="moves">0</span> moves
                </div>
            </div>
            
            <div class="board size-4" id="board"></div>
            
            <div class="palette" id="palette"></div>
        </div>

        <!-- Actions -->
        <div class="actions">
            <button class="action-btn" onclick="undo()" id="undoBtn" disabled>
                ‚Ü©Ô∏è Undo
            </button>
            <button class="action-btn check" onclick="checkBoard()" id="checkBtn">
                ‚úÖ Check
            </button>
            <button class="action-btn hint" onclick="giveHint()" id="hintBtn">
                üí° Hint
            </button>
            <button class="action-btn primary" onclick="newGame()">
                üéÆ New Game
            </button>
        </div>
    </div>

    <!-- Mascot -->
    <div class="mascot" id="mascot" onclick="mascotSpeak()">ü¶ä</div>
    <div class="mascot-bubble" id="mascotBubble">Welcome! Let's play!</div>

    <!-- Settings Button -->
    <button class="settings-btn" onclick="toggleSound()">üîä</button>

    <!-- Win Modal -->
    <div class="modal-overlay" id="winModal">
        <div class="modal">
            <div class="modal-icon">üéâ</div>
            <div class="modal-title">Amazing!</div>
            <div class="modal-text" id="winText">You completed the puzzle!</div>
            
            <div class="stars-container" id="starsContainer">
                <span class="star">‚≠ê</span>
                <span class="star">‚≠ê</span>
                <span class="star">‚≠ê</span>
            </div>
            
            <div class="reward-badge">
                <span>+</span>
                <span id="rewardStars">3</span>
                <span>‚≠ê</span>
            </div>
            
            <div class="modal-buttons">
                <button class="action-btn" onclick="closeWinModal()">
                    üè† Menu
                </button>
                <button class="action-btn primary" onclick="playAgain()">
                    üéÆ Play Again
                </button>
            </div>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div class="tutorial-overlay" id="tutorialOverlay">
        <div class="tutorial-card">
            <div class="tutorial-icon" id="tutorialIcon">üéÆ</div>
            <div class="tutorial-title" id="tutorialTitle">Welcome!</div>
            <div class="tutorial-text" id="tutorialText">Let's learn how to play!</div>
            
            <div class="tutorial-demo" id="tutorialDemo"></div>
            
            <div class="tutorial-dots" id="tutorialDots"></div>
            
            <button class="tutorial-btn" onclick="nextTutorialStep()" id="tutorialBtn">
                Let's Go! üöÄ
            </button>
        </div>
    </div>

    <script>
        // ============== ICON THEMES ==============
        const ICON_THEMES = {
            animals: {
                name: 'Animals',
                icon: 'üê∂',
                mascot: 'ü¶ä',
                icons: {
                    4: ['üê∂', 'üê±', 'üê∞', 'üêª'],
                    6: ['üê∂', 'üê±', 'üê∞', 'üêª', 'üêº', 'ü¶Å'],
                    9: ['üê∂', 'üê±', 'üê∞', 'üêª', 'üêº', 'ü¶Å', 'üê∏', 'üêß', 'üê®']
                },
                bg: 'linear-gradient(135deg, #a8e6cf, #dcedc1)'
            },
            dinos: {
                name: 'Dinos',
                icon: 'ü¶ï',
                mascot: 'ü¶ñ',
                icons: {
                    4: ['ü¶ï', 'ü¶ñ', 'ü¶¥', 'üåã'],
                    6: ['ü¶ï', 'ü¶ñ', 'ü¶¥', 'üåã', 'ü•ö', 'üåø'],
                    9: ['ü¶ï', 'ü¶ñ', 'ü¶¥', 'üåã', 'ü•ö', 'üåø', 'ü™®', 'ü¶é', 'üå¥']
                },
                bg: 'linear-gradient(135deg, #c9b1ff, #e0c3fc)'
            },
            ocean: {
                name: 'Ocean',
                icon: 'üê†',
                mascot: 'üêô',
                icons: {
                    4: ['üê†', 'üêô', 'ü¶Ä', 'üêö'],
                    6: ['üê†', 'üêô', 'ü¶Ä', 'üêö', 'ü¶à', 'üê≥'],
                    9: ['üê†', 'üêô', 'ü¶Ä', 'üêö', 'ü¶à', 'üê≥', 'ü¶ë', 'üê°', 'ü¶ê']
                },
                bg: 'linear-gradient(135deg, #89CFF0, #a0e7e5)'
            },
            space: {
                name: 'Space',
                icon: 'üöÄ',
                mascot: 'üëΩ',
                icons: {
                    4: ['üöÄ', '‚≠ê', 'üåô', 'ü™ê'],
                    6: ['üöÄ', '‚≠ê', 'üåô', 'ü™ê', 'üëΩ', 'üõ∏'],
                    9: ['üöÄ', '‚≠ê', 'üåô', 'ü™ê', 'üëΩ', 'üõ∏', '‚òÑÔ∏è', 'üåç', 'üî≠']
                },
                bg: 'linear-gradient(135deg, #2c3e50, #4a69bd)'
            },
            food: {
                name: 'Yummy',
                icon: 'üçï',
                mascot: 'üç¶',
                icons: {
                    4: ['üçï', 'üçî', 'üçü', 'üåÆ'],
                    6: ['üçï', 'üçî', 'üçü', 'üåÆ', 'üç©', 'üç¶'],
                    9: ['üçï', 'üçî', 'üçü', 'üåÆ', 'üç©', 'üç¶', 'üßÅ', 'üç™', 'üç≠']
                },
                bg: 'linear-gradient(135deg, #ffeaa7, #fdcb6e)'
            },
            sports: {
                name: 'Sports',
                icon: '‚öΩ',
                mascot: 'üèÜ',
                icons: {
                    4: ['‚öΩ', 'üèÄ', 'üéæ', '‚öæ'],
                    6: ['‚öΩ', 'üèÄ', 'üéæ', '‚öæ', 'üèà', 'üé±'],
                    9: ['‚öΩ', 'üèÄ', 'üéæ', '‚öæ', 'üèà', 'üé±', 'üèê', 'ü•é', 'üèì']
                },
                bg: 'linear-gradient(135deg, #74b9ff, #a29bfe)'
            },
            nature: {
                name: 'Nature',
                icon: 'üå∏',
                mascot: 'ü¶ã',
                icons: {
                    4: ['üå∏', 'üåª', 'üå∫', 'üå∑'],
                    6: ['üå∏', 'üåª', 'üå∫', 'üå∑', 'üåπ', 'üåº'],
                    9: ['üå∏', 'üåª', 'üå∫', 'üå∑', 'üåπ', 'üåº', 'ü™∑', 'üíê', 'üåæ']
                },
                bg: 'linear-gradient(135deg, #fab1a0, #ffeaa7)'
            },
            bugs: {
                name: 'Bugs',
                icon: 'üêõ',
                mascot: 'üêù',
                icons: {
                    4: ['üêõ', 'ü¶ã', 'üêù', 'üêû'],
                    6: ['üêõ', 'ü¶ã', 'üêù', 'üêû', 'üêú', 'ü¶ó'],
                    9: ['üêõ', 'ü¶ã', 'üêù', 'üêû', 'üêú', 'ü¶ó', 'ü™≤', 'ü¶ü', 'üï∑Ô∏è']
                },
                bg: 'linear-gradient(135deg, #b8e994, #78e08f)'
            }
        };

        // Box dimensions for different grid sizes
        const BOX_DIMS = {
            4: { rows: 2, cols: 2 },
            6: { rows: 2, cols: 3 },
            9: { rows: 3, cols: 3 }
        };

        // ============== GAME STATE ==============
        let gridSize = 4;
        let currentTheme = 'animals';
        let board = [];
        let solution = [];
        let fixed = [];
        let selectedCell = null;
        let selectedIcon = null;
        let seconds = 0;
        let moves = 0;
        let timerInterval = null;
        let undoStack = [];
        let soundEnabled = true;
        let audioContext = null;

        // Player stats
        let stats = {
            totalStars: 0,
            gamesWon: 0,
            streak: 0,
            lastPlayDate: null,
            tutorialDone: false
        };

        // Mascot messages
        const MASCOT_MESSAGES = {
            start: ["Let's play!", "You got this!", "I believe in you!", "This will be fun!"],
            hint: ["Here's a hint!", "Try this one!", "Look here!", "This might help!"],
            correct: ["Great job!", "Amazing!", "You're so smart!", "Woohoo!", "Perfect!"],
            error: ["Oops! Try again!", "Not quite!", "Keep trying!", "Almost!"],
            win: ["YOU DID IT!", "AMAZING!", "SO PROUD!", "CHAMPION!"],
            encourage: ["Keep going!", "You're doing great!", "Almost there!", "Don't give up!"]
        };

        // ============== INITIALIZATION ==============
        function init() {
            loadStats();
            renderThemeGrid();
            updateStatsDisplay();
            
            if (!stats.tutorialDone) {
                showTutorial();
            } else {
                newGame();
            }
            
            // Initialize audio
            document.addEventListener('click', initAudio, { once: true });
            document.addEventListener('touchstart', initAudio, { once: true });
        }

        function loadStats() {
            const saved = localStorage.getItem('sudokuKidsStats');
            if (saved) {
                stats = { ...stats, ...JSON.parse(saved) };
            }
            checkStreak();
        }

        function saveStats() {
            localStorage.setItem('sudokuKidsStats', JSON.stringify(stats));
        }

        function checkStreak() {
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            if (stats.lastPlayDate !== today && stats.lastPlayDate !== yesterday) {
                stats.streak = 0;
            }
        }

        function updateStatsDisplay() {
            document.getElementById('totalStars').textContent = stats.totalStars;
            document.getElementById('gamesWon').textContent = stats.gamesWon;
            document.getElementById('streak').textContent = stats.streak;
        }

        // ============== AUDIO ==============
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        function playSound(type) {
            if (!soundEnabled || !audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            switch(type) {
                case 'tap':
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.1);
                    break;
                case 'place':
                    oscillator.frequency.setValueAtTime(523, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(659, audioContext.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.2);
                    break;
                case 'error':
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.2);
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.2);
                    break;
                case 'win':
                    const notes = [523, 659, 784, 1047];
                    notes.forEach((freq, i) => {
                        const osc = audioContext.createOscillator();
                        const gain = audioContext.createGain();
                        osc.connect(gain);
                        gain.connect(audioContext.destination);
                        osc.frequency.setValueAtTime(freq, audioContext.currentTime + i * 0.15);
                        gain.gain.setValueAtTime(0.3, audioContext.currentTime + i * 0.15);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.15 + 0.3);
                        osc.start(audioContext.currentTime + i * 0.15);
                        osc.stop(audioContext.currentTime + i * 0.15 + 0.3);
                    });
                    break;
                case 'hint':
                    oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(1320, audioContext.currentTime + 0.15);
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.15);
                    break;
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.querySelector('.settings-btn').textContent = soundEnabled ? 'üîä' : 'üîá';
        }

        // ============== THEME ==============
        function renderThemeGrid() {
            const grid = document.getElementById('themeGrid');
            grid.innerHTML = '';
            
            for (const [key, theme] of Object.entries(ICON_THEMES)) {
                const option = document.createElement('div');
                option.className = `theme-option ${key === currentTheme ? 'active' : ''}`;
                option.style.background = theme.bg;
                option.innerHTML = `
                    <span class="theme-icon">${theme.icon}</span>
                    <span class="theme-name">${theme.name}</span>
                `;
                option.onclick = () => selectTheme(key);
                grid.appendChild(option);
            }
        }

        function selectTheme(themeKey) {
            currentTheme = themeKey;
            renderThemeGrid();
            
            // Update mascot
            document.getElementById('mascot').textContent = ICON_THEMES[currentTheme].mascot;
            
            // Restart game with new theme
            newGame();
            
            mascotSay(MASCOT_MESSAGES.start);
            playSound('tap');
        }

        // ============== SIZE ==============
        function selectSize(size) {
            gridSize = size;
            
            // Update buttons
            document.querySelectorAll('.size-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.size) === size);
            });
            
            // Update difficulty badge
            const badges = { 4: 'üåü Easy', 6: '‚≠ê Medium', 9: 'üí™ Hard' };
            document.getElementById('difficultyBadge').textContent = badges[size];
            
            newGame();
            playSound('tap');
        }

        // ============== GAME LOGIC ==============
        function newGame() {
            // Reset state
            selectedCell = null;
            selectedIcon = null;
            seconds = 0;
            moves = 0;
            undoStack = [];
            
            // Update board class
            const boardEl = document.getElementById('board');
            boardEl.className = `board size-${gridSize}`;
            
            // Generate puzzle
            generatePuzzle();
            
            // Render
            renderBoard();
            renderPalette();
            updateTimer();
            document.getElementById('moves').textContent = moves;
            document.getElementById('undoBtn').disabled = true;
            
            // Start timer
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                seconds++;
                updateTimer();
            }, 1000);
            
            mascotSay(MASCOT_MESSAGES.start);
        }

        function generatePuzzle() {
            // Initialize empty board
            board = Array(gridSize).fill(null).map(() => Array(gridSize).fill(0));
            solution = Array(gridSize).fill(null).map(() => Array(gridSize).fill(0));
            fixed = Array(gridSize).fill(null).map(() => Array(gridSize).fill(false));
            
            // Generate solution
            fillBoard(solution, 0, 0);
            
            // Copy solution to board
            for (let r = 0; r < gridSize; r++) {
                for (let c = 0; c < gridSize; c++) {
                    board[r][c] = solution[r][c];
                }
            }
            
            // Remove cells based on difficulty
            const cellsToRemove = {
                4: 6,   // Remove ~37%
                6: 18,  // Remove ~50%
                9: 45   // Remove ~55%
            };
            
            const cells = [];
            for (let r = 0; r < gridSize; r++) {
                for (let c = 0; c < gridSize; c++) {
                    cells.push([r, c]);
                }
            }
            shuffleArray(cells);
            
            for (let i = 0; i < cellsToRemove[gridSize]; i++) {
                const [r, c] = cells[i];
                board[r][c] = 0;
            }
            
            // Mark fixed cells
            for (let r = 0; r < gridSize; r++) {
                for (let c = 0; c < gridSize; c++) {
                    fixed[r][c] = board[r][c] !== 0;
                }
            }
        }

        function fillBoard(grid, row, col) {
            if (col === gridSize) {
                row++;
                col = 0;
            }
            if (row === gridSize) return true;
            
            const nums = Array.from({ length: gridSize }, (_, i) => i + 1);
            shuffleArray(nums);
            
            for (const num of nums) {
                if (isValidPlacement(grid, row, col, num)) {
                    grid[row][col] = num;
                    if (fillBoard(grid, row, col + 1)) return true;
                    grid[row][col] = 0;
                }
            }
            return false;
        }

        function isValidPlacement(grid, row, col, num) {
            // Check row
            for (let c = 0; c < gridSize; c++) {
                if (grid[row][c] === num) return false;
            }
            
            // Check column
            for (let r = 0; r < gridSize; r++) {
                if (grid[r][col] === num) return false;
            }
            
            // Check box
            const { rows: boxRows, cols: boxCols } = BOX_DIMS[gridSize];
            const boxStartRow = Math.floor(row / boxRows) * boxRows;
            const boxStartCol = Math.floor(col / boxCols) * boxCols;
            
            for (let r = boxStartRow; r < boxStartRow + boxRows; r++) {
                for (let c = boxStartCol; c < boxStartCol + boxCols; c++) {
                    if (grid[r][c] === num) return false;
                }
            }
            
            return true;
        }

        function shuffleArray(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        }

        // ============== RENDERING ==============
        function renderBoard() {
            const boardEl = document.getElementById('board');
            boardEl.innerHTML = '';
            
            const icons = ICON_THEMES[currentTheme].icons[gridSize];
            const { rows: boxRows, cols: boxCols } = BOX_DIMS[gridSize];
            const numBoxesX = gridSize / boxCols;
            const numBoxesY = gridSize / boxRows;
            
            // Create boxes
            for (let boxY = 0; boxY < numBoxesY; boxY++) {
                for (let boxX = 0; boxX < numBoxesX; boxX++) {
                    const box = document.createElement('div');
                    box.className = 'box';
                    
                    // Create cells within this box
                    for (let cellY = 0; cellY < boxRows; cellY++) {
                        for (let cellX = 0; cellX < boxCols; cellX++) {
                            const r = boxY * boxRows + cellY;
                            const c = boxX * boxCols + cellX;
                            
                            const cell = document.createElement('div');
                            cell.className = 'cell';
                            cell.dataset.row = r;
                            cell.dataset.col = c;
                            
                            if (fixed[r][c]) cell.classList.add('fixed');
                            if (selectedCell && selectedCell.row === r && selectedCell.col === c) {
                                cell.classList.add('selected');
                            }
                            
                            // Show icon
                            if (board[r][c] !== 0) {
                                cell.textContent = icons[board[r][c] - 1];
                            }
                            
                            cell.onclick = () => selectCell(r, c);
                            box.appendChild(cell);
                        }
                    }
                    
                    boardEl.appendChild(box);
                }
            }
        }

        function renderPalette() {
            const palette = document.getElementById('palette');
            palette.innerHTML = '';
            
            const icons = ICON_THEMES[currentTheme].icons[gridSize];
            
            // Count remaining for each icon
            const counts = Array(gridSize).fill(gridSize);
            for (let r = 0; r < gridSize; r++) {
                for (let c = 0; c < gridSize; c++) {
                    if (board[r][c] !== 0) {
                        counts[board[r][c] - 1]--;
                    }
                }
            }
            
            // Eraser
            const eraser = document.createElement('div');
            eraser.className = `palette-item eraser ${selectedIcon === 0 ? 'selected' : ''}`;
            eraser.textContent = 'üßπ';
            eraser.onclick = () => selectIcon(0);
            palette.appendChild(eraser);
            
            // Icons
            icons.forEach((icon, idx) => {
                const item = document.createElement('div');
                item.className = `palette-item ${selectedIcon === idx + 1 ? 'selected' : ''}`;
                item.innerHTML = `
                    ${icon}
                    <span class="remaining ${counts[idx] === 0 ? 'done' : ''}">${counts[idx]}</span>
                `;
                item.onclick = () => selectIcon(idx + 1);
                palette.appendChild(item);
            });
        }

        function updateTimer() {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            document.getElementById('timer').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // ============== INTERACTION ==============
        function selectCell(row, col) {
            if (fixed[row][col]) {
                playSound('tap');
                return;
            }
            
            playSound('tap');
            
            // If icon is selected, place it
            if (selectedIcon !== null) {
                placeIcon(row, col, selectedIcon);
                return;
            }
            
            // Select/deselect cell
            if (selectedCell && selectedCell.row === row && selectedCell.col === col) {
                selectedCell = null;
            } else {
                selectedCell = { row, col };
            }
            
            renderBoard();
        }

        function selectIcon(iconIdx) {
            playSound('tap');
            
            // If cell is selected, place icon
            if (selectedCell && !fixed[selectedCell.row][selectedCell.col]) {
                placeIcon(selectedCell.row, selectedCell.col, iconIdx);
                return;
            }
            
            // Toggle icon selection
            selectedIcon = selectedIcon === iconIdx ? null : iconIdx;
            renderPalette();
        }

        function placeIcon(row, col, iconIdx) {
            if (fixed[row][col]) return;
            if (board[row][col] === iconIdx) return;
            
            // Validate placement
            if (iconIdx !== 0) {
                const tempBoard = board.map(r => [...r]);
                tempBoard[row][col] = 0;
                
                if (!isValidPlacement(tempBoard, row, col, iconIdx)) {
                    // Invalid move
                    const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
                    cell.classList.add('error');
                    setTimeout(() => cell.classList.remove('error'), 400);
                    
                    playSound('error');
                    mascotSay(MASCOT_MESSAGES.error);
                    return;
                }
            }
            
            // Save to undo stack
            undoStack.push({
                row, col,
                oldValue: board[row][col],
                newValue: iconIdx
            });
            document.getElementById('undoBtn').disabled = false;
            
            // Place icon
            board[row][col] = iconIdx;
            moves++;
            document.getElementById('moves').textContent = moves;
            
            renderBoard();
            renderPalette();
            
            // Animate
            const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
            if (iconIdx !== 0) {
                cell.classList.add('correct');
                setTimeout(() => cell.classList.remove('correct'), 300);
                playSound('place');
                
                // Random encouragement
                if (Math.random() < 0.3) {
                    mascotSay(MASCOT_MESSAGES.correct);
                }
            }
            
            // Clear selection
            selectedCell = null;
            selectedIcon = null;
            
            // Check win
            if (isBoardComplete()) {
                handleWin();
            }
        }

        function undo() {
            if (undoStack.length === 0) return;
            
            const action = undoStack.pop();
            board[action.row][action.col] = action.oldValue;
            moves++;
            document.getElementById('moves').textContent = moves;
            
            renderBoard();
            renderPalette();
            
            document.getElementById('undoBtn').disabled = undoStack.length === 0;
            playSound('tap');
        }

        function giveHint() {
            // Find empty cell
            const emptyCells = [];
            for (let r = 0; r < gridSize; r++) {
                for (let c = 0; c < gridSize; c++) {
                    if (board[r][c] === 0) {
                        emptyCells.push([r, c]);
                    }
                }
            }
            
            if (emptyCells.length === 0) return;
            
            shuffleArray(emptyCells);
            const [row, col] = emptyCells[0];
            
            // Show hint
            board[row][col] = solution[row][col];
            fixed[row][col] = true;
            
            renderBoard();
            renderPalette();
            
            // Animate hint
            const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
            cell.classList.add('hint');
            setTimeout(() => cell.classList.remove('hint'), 1000);
            
            playSound('hint');
            mascotSay(MASCOT_MESSAGES.hint);
            
            // Check win
            if (isBoardComplete()) {
                setTimeout(handleWin, 500);
            }
        }

        // ============== CHECK ==============
        function checkBoard() {
            playSound('tap');
            let hasErrors = false;
            let hasCorrect = false;

            // Clear previous check states
            document.querySelectorAll('.cell').forEach(cell => {
                cell.classList.remove('wrong', 'right');
            });

            // Check each non-fixed, non-empty cell
            for (let r = 0; r < gridSize; r++) {
                for (let c = 0; c < gridSize; c++) {
                    if (!fixed[r][c] && board[r][c] !== 0) {
                        const cell = document.querySelector(`.cell[data-row="${r}"][data-col="${c}"]`);
                        if (board[r][c] === solution[r][c]) {
                            cell.classList.add('right');
                            hasCorrect = true;
                        } else {
                            cell.classList.add('wrong');
                            hasErrors = true;
                        }
                    }
                }
            }

            // Mascot feedback
            if (hasErrors) {
                playSound('error');
                mascotSay(["Some aren't right!", "Check the red ones!", "Keep trying!", "Almost there!"]);
            } else if (hasCorrect) {
                playSound('place');
                mascotSay(["Looking good!", "All correct so far!", "Great job!", "Keep going!"]);
            } else {
                mascotSay(["Place some icons first!", "Try filling in cells!", "Pick an icon!"]);
            }

            // Remove highlighting after 3 seconds
            setTimeout(() => {
                document.querySelectorAll('.cell').forEach(cell => {
                    cell.classList.remove('wrong', 'right');
                });
            }, 3000);
        }

        // ============== WIN ==============
        function isBoardComplete() {
            for (let r = 0; r < gridSize; r++) {
                for (let c = 0; c < gridSize; c++) {
                    if (board[r][c] === 0) return false;
                }
            }
            return true;
        }

        function handleWin() {
            clearInterval(timerInterval);
            playSound('win');
            createConfetti();
            
            // Calculate stars
            const maxTime = { 4: 60, 6: 180, 9: 420 };
            const maxMoves = { 4: 12, 6: 30, 9: 60 };
            
            let stars = 1;
            if (seconds < maxTime[gridSize]) stars++;
            if (moves < maxMoves[gridSize]) stars++;
            
            // Update stats
            stats.totalStars += stars;
            stats.gamesWon++;
            
            const today = new Date().toDateString();
            if (stats.lastPlayDate !== today) {
                stats.streak++;
                stats.lastPlayDate = today;
            }
            
            saveStats();
            updateStatsDisplay();
            
            // Show modal
            showWinModal(stars);
            mascotSay(MASCOT_MESSAGES.win);
        }

        function showWinModal(stars) {
            const modal = document.getElementById('winModal');
            
            // Set stars
            document.querySelectorAll('#starsContainer .star').forEach((star, i) => {
                star.classList.toggle('earned', i < stars);
            });
            
            document.getElementById('rewardStars').textContent = stars;
            document.getElementById('winText').textContent = 
                `Time: ${document.getElementById('timer').textContent} ‚Ä¢ Moves: ${moves}`;
            
            modal.classList.add('show');
        }

        function closeWinModal() {
            document.getElementById('winModal').classList.remove('show');
        }

        function playAgain() {
            closeWinModal();
            newGame();
        }

        function createConfetti() {
            const colors = ['#6B5CE7', '#FF6B9D', '#FFD93D', '#6BCB77', '#74b9ff'];
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.animationDuration = (2 + Math.random()) + 's';
                document.body.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 3000);
            }
        }

        // ============== MASCOT ==============
        function mascotSay(messages) {
            const message = Array.isArray(messages) 
                ? messages[Math.floor(Math.random() * messages.length)]
                : messages;
            
            const bubble = document.getElementById('mascotBubble');
            bubble.textContent = message;
            bubble.classList.add('show');
            
            setTimeout(() => bubble.classList.remove('show'), 2500);
        }

        function mascotSpeak() {
            mascotSay(MASCOT_MESSAGES.encourage);
            playSound('tap');
            
            // Bounce animation
            const mascot = document.getElementById('mascot');
            mascot.style.animation = 'none';
            mascot.offsetHeight; // Trigger reflow
            mascot.style.animation = 'bounce 0.5s ease';
            setTimeout(() => mascot.style.animation = 'float 3s ease-in-out infinite', 500);
        }

        // ============== TUTORIAL ==============
        const tutorialSteps = [
            {
                icon: 'üéÆ',
                title: 'Welcome!',
                text: 'Let\'s learn how to play Sudoku with fun pictures!',
                demo: 'welcome'
            },
            {
                icon: 'üß©',
                title: 'The Rule',
                text: 'Each picture can only appear ONCE in each row, column, and box!',
                demo: 'rule'
            },
            {
                icon: 'üëÜ',
                title: 'How to Play',
                text: 'Tap an empty square, then tap the picture you want to put there!',
                demo: 'play'
            },
            {
                icon: '‚≠ê',
                title: 'Earn Stars!',
                text: 'Complete puzzles quickly and with few moves to earn more stars!',
                demo: 'stars'
            },
            {
                icon: 'üéâ',
                title: 'Ready?',
                text: 'You\'re all set! Start with the easy 4√ó4 puzzles and work your way up!',
                demo: 'ready'
            }
        ];

        let tutorialStep = 0;

        function showTutorial() {
            tutorialStep = 0;
            renderTutorialStep();
            document.getElementById('tutorialOverlay').classList.add('show');
        }

        function renderTutorialStep() {
            const step = tutorialSteps[tutorialStep];
            
            document.getElementById('tutorialIcon').textContent = step.icon;
            document.getElementById('tutorialTitle').textContent = step.title;
            document.getElementById('tutorialText').textContent = step.text;
            
            // Dots
            const dots = document.getElementById('tutorialDots');
            dots.innerHTML = tutorialSteps.map((_, i) => 
                `<div class="tutorial-dot ${i === tutorialStep ? 'active' : ''}"></div>`
            ).join('');
            
            // Demo
            renderTutorialDemo(step.demo);
            
            // Button
            const btn = document.getElementById('tutorialBtn');
            btn.textContent = tutorialStep === tutorialSteps.length - 1 ? 'Let\'s Play! üöÄ' : 'Next ‚Üí';
        }

        function renderTutorialDemo(type) {
            const demo = document.getElementById('tutorialDemo');
            const icons = ['üê∂', 'üê±', 'üê∞', 'üêª'];
            
            switch(type) {
                case 'welcome':
                    demo.innerHTML = `
                        <div class="tutorial-mini-grid">
                            ${icons.map(i => `<div class="tutorial-mini-cell">${i}</div>`).join('')}
                        </div>
                    `;
                    break;
                case 'rule':
                    demo.innerHTML = `
                        <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                            <div>
                                <div style="font-size: 0.8rem; margin-bottom: 5px;">‚úÖ Good!</div>
                                <div class="tutorial-mini-grid">
                                    <div class="tutorial-mini-cell">üê∂</div>
                                    <div class="tutorial-mini-cell">üê±</div>
                                    <div class="tutorial-mini-cell">üê∞</div>
                                    <div class="tutorial-mini-cell">üêª</div>
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 0.8rem; margin-bottom: 5px;">‚ùå Wrong!</div>
                                <div class="tutorial-mini-grid">
                                    <div class="tutorial-mini-cell">üê∂</div>
                                    <div class="tutorial-mini-cell" style="color: red;">üê∂</div>
                                    <div class="tutorial-mini-cell">üê∞</div>
                                    <div class="tutorial-mini-cell">üêª</div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'play':
                    demo.innerHTML = `
                        <div class="tutorial-mini-grid">
                            <div class="tutorial-mini-cell">üê∂</div>
                            <div class="tutorial-mini-cell highlight"></div>
                            <div class="tutorial-mini-cell">üê∞</div>
                            <div class="tutorial-mini-cell">üêª</div>
                        </div>
                        <div style="margin-top: 10px;">
                            <span style="font-size: 1.5rem; padding: 5px 15px; background: white; border-radius: 10px; border: 2px solid var(--primary);">üê±</span>
                        </div>
                    `;
                    break;
                case 'stars':
                    demo.innerHTML = `
                        <div style="font-size: 2.5rem;">‚≠ê ‚≠ê ‚≠ê</div>
                        <div style="margin-top: 10px; font-size: 0.9rem;">Fast + Few moves = More stars!</div>
                    `;
                    break;
                case 'ready':
                    demo.innerHTML = `
                        <div style="font-size: 4rem;">üéâ</div>
                    `;
                    break;
            }
        }

        function nextTutorialStep() {
            playSound('tap');
            
            if (tutorialStep < tutorialSteps.length - 1) {
                tutorialStep++;
                renderTutorialStep();
            } else {
                // Close tutorial
                document.getElementById('tutorialOverlay').classList.remove('show');
                stats.tutorialDone = true;
                saveStats();
                newGame();
            }
        }

        // ============== START ==============
        init();
    </script>
</body>
</html>
